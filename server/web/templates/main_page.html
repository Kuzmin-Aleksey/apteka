<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лекарства в дорогу - аптека с быстрой доставкой</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/static/js/cookie.js"></script>
    <script src="/static/js/util.js"></script>
    <style>
        :root {
            --primary-color: #2a7f62;
            --secondary-color: #f8f9fa;
            --accent-color: #ff6b6b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 70px; /* Для плавающей кнопки */
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        .navbar-brand img {
            height: 40px;
            flex-direction: column;
            align-items: flex-start!important;
        }

        .pharmacy-card {
            transition: transform 0.3s, box-shadow 0.3s;
            border-radius: 10px;
            overflow: hidden;
        }

        .pharmacy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .product-card {
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            height: 100%;
            cursor: pointer;
        }

        .product-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .promotion-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8rem;
        }

        .product-img {
            height: 180px;
            object-fit: contain;
            background-color: #f8f9fa;
            padding: 10px;
        }

        .old-price {
            text-decoration: line-through;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .cart-item-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        #map {
            height: 400px;
            border-radius: 10px;
        }

        .store-info {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 20px;
        }

        .search-box {
            position: relative;
        }

        .search-box .btn {
            position: absolute;
            right: 0;
            top: 0;
        }

        .out-of-stock {
            opacity: 0.6;
            position: relative;
        }

        .out-of-stock::after {
            content: "Нет в наличии";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--accent-color);
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .quantity-control {
            display: flex;
            align-items: center;
        }

        .quantity-control button {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .quantity-control input {
            width: 40px;
            text-align: center;
            margin: 0 5px;
        }

        .cart-item-img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-control button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border: none;
        }

        .quantity-control input {
            width: 40px;
            text-align: center;
        }

        #cartItems .list-group-item {
            border-radius: 0;
            border-left: 0;
            border-right: 0;
        }

        .offcanvas-body .sticky-bottom {
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        /* Пагинация */
        #paginationContainer .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        #paginationContainer .page-link {
            color: var(--primary-color);
        }

        #paginationContainer .page-link:hover {
            color: #1a6049;
        }

        #searchResultsTitle {
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Стили для статусов заказа */
        #orderStatusIcon i {
            transition: all 0.5s ease;
        }

        #orderStatusTitle {
            transition: all 0.3s ease;
        }

        .progress-bar {
            transition: width 0.8s ease-in-out;
        }

        .list-group-item {
            padding: 0.75rem 0;
            border-color: rgba(0,0,0,0.05);
        }

        /* Плавающая кнопка корзины для мобильных */
        .floating-cart-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none; /* По умолчанию скрыта */
        }

        .floating-cart-btn .btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .floating-cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
        }

        @media (min-width: 992px) {
            .col-lg-10 {
                flex: 0 0 auto;
                width: 75%;
            }
        }

        @media (max-width: 992px) {

            .navbar-brand img {
                height: 30px;
            }

            .floating-cart-btn {
                display: block; /* Видна только на мобильных */
            }


            .d-lg-none .text-white {
                font-size: 0.8rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 120px;
            }

            body {
                padding-bottom: 80px; /* Больше места для кнопки */
            }
        }

    </style>
</head>
<body>

{{template "navbar" .}}


<!-- Основное содержимое -->
<div class="container my-4">
    <div class="row">
        <!-- Блок поиска и товаров -->
        <div class="col-lg-10 m-auto">
            <!-- Блок поиска -->
            <div class="search-box mb-4">
                <input type="text" class="form-control pe-5" id="searchInput" placeholder="Поиск лекарств и товаров...">
                <button class="btn btn-primary" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <!-- Результаты поиска (изначально скрыт) -->
            <div id="searchResults" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Результаты поиска</h4>
                    <span id="searchResultsCount" class="badge bg-primary">Найдено: 0</span>
                </div>

                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4" id="searchResultsContainer">
                    <!-- Здесь будут карточки найденных товаров -->
                </div>
            </div>

            <!-- Пагинация -->
            <div class="d-flex justify-content-center mt-4">
                <nav aria-label="Page navigation">
                    <ul class="pagination" id="pagination">
                        <!-- Пагинация будет генерироваться динамически -->
                    </ul>
                </nav>
            </div>

            <!-- Модальное окно с детальной информацией о товаре -->
            <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="productModalTitle">Название товара</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <img id="productModalImage"
                                         src="https://via.placeholder.com/400x400?text=Изображение+товара"
                                         class="img-fluid rounded mb-3" alt="Изображение товара">
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <h6>Описание</h6>
                                        <p id="productModalDescription">Описание товара будет здесь</p>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <h6>Цена</h6>
                                            <div class="h4 text-primary" id="productModalPrice">0 ₽</div>
                                            <div class="text-muted small" id="productModalOldPrice"></div>
                                        </div>
                                        <div class="col-6">
                                            <h6>Наличие</h6>
                                            <span id="productModalStock" class="badge bg-success">В наличии</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <h6>Производитель</h6>
                                        <p id="productModalProducer">Не указано</p>
                                    </div>
                                    <div class="mb-3">
                                        <h6>Страна</h6>
                                        <p id="productModalCountry">Не указано</p>
                                    </div>
                                    <div class="mb-3">
                                        <h6>GTIN</h6>
                                        <p id="productModalGTIN">Не указано</p>
                                    </div>
                                    <div class="quantity-control d-flex align-items-center mb-3">
                                        <p>Количество: <span id="productModalQuantity"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                            <button type="button" class="btn btn-primary" id="addToCartFromModal">
                                <i class="fas fa-cart-plus me-1"></i> Добавить в корзину
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <h4 class="mb-3">Акции</h4>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4" id="promotionsContainer">
                <!-- Акции будут загружаться здесь -->

            </div>
        </div>
    </div>
</div>

<!-- Плавающая кнопка корзины для мобильных -->
<div class="floating-cart-btn">
    <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
        <i class="fas fa-shopping-cart fa-lg"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger floating-cart-badge" id="floatingCartCount">0</span>
    </button>
</div>

<!-- Оффканвас корзины -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title">Ваша корзина</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        <div class="list-group list-group-flush" id="cartItems">
            <!-- Товары в корзине будут здесь -->
        </div>

        <div class="sticky-bottom bg-white border-top p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Итого:</h5>
                <h5 class="text-primary mb-0" id="cartTotal">0 ₽</h5>
            </div>
            <div id="disable-booking-alert" class="d-none alert alert-light border small mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Извините, на данный момент бронирование не доступно.
            </div>
            <button class="btn btn-primary w-100 mb-2" id="checkoutBtn">
                <i class="fas fa-shopping-bag me-2"></i>Оформить заказ
            </button>
            <button class="btn btn-outline-secondary w-100" id="clearCartBtn">
                <i class="fas fa-trash-alt me-2"></i>Очистить корзину
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно оформления заказа -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">Оформление бронирования</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="orderForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ваше имя</label>
                        <input name="username" type="text" class="form-control" required placeholder="Иван Иванов">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Телефон</label>
                        <input name="phone" type="tel" class="form-control" required placeholder="+7 (900) 123-45-67">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Комментарий к заказу</label>
                        <textarea name="message" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="alert alert-light border small mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        После оформления заказа товары будут забронированы в выбранной аптеке на <span id="booking-delay">24 часа</span>.
                        Статус бронирования можно отслеживать во вкладке "Мои заказы".
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button id="booking-btn" type="submit" class="btn btn-primary">Забронировать</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Подвал -->
<footer class="bg-dark text-white py-4 mt-4">
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <h5>Лекарства в дорогу</h5>
                <p>Аптечная сеть с быстрой доставкой лекарств и товаров для здоровья.</p>
            </div>
            <div class="col-md-4">
                <h5>Контакты</h5>
                <ul class="list-unstyled">
                    <li><i class="fas fa-phone me-2"></i> +7 (123) 456-7890</li>
                    <li><i class="fas fa-envelope me-2"></i> info@lekarstva-v-dorogu.ru</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h5>Режим работы</h5>
                <p id="schedule">Не указан</p>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const params = new URLSearchParams(location.search);
    const storeId = Number.parseInt(params.get("store"));
    let storeInfo = {};
    let products = [];
    let promotions = [];
    let promoProducts = {};
    let cartCount = 0;
    let cartItems = [];

    saveStoreId(storeId);
    setActiveLink("main-page-link");

    function CheckCode(xhr) {
        if (xhr.status === StatusOk) {
            return true
        }
        alert(`Ошибка ${xhr.status}`)
        return false
    }

    // Получение информации об аптеке
    function getStoreInfo() {
        let xhr = new XMLHttpRequest();

        xhr.responseType = "json"
        xhr.onload = () => {
            if (!CheckCode(xhr)) {
                return;
            }

            xhr.response.forEach(s => {
                if (s.id === storeId) {
                    storeInfo = s;
                }
            })
            if (storeInfo === {}) {
                alert("Аптека не найдена");
                location.replace("/");
            }


            if (!storeInfo.booking_enable) {
                document.getElementById("disable-booking-alert").classList.remove("d-none");
                document.getElementById("checkoutBtn").setAttribute("disabled", "");
                document.getElementById("booking-btn").setAttribute("disabled", "");
            }
            if (storeInfo.schedule) {
                document.getElementById("schedule").innerText = storeInfo.schedule;
            }
        }
        xhr.open("GET", `/api/stores/get`);
        xhr.send();
    }


    // Получение времени бронирования
    function getBookingDelay() {
        xhr = new XMLHttpRequest();

        xhr.onload = () => {
            if (!CheckCode(xhr)) {
                return;
            }

            document.getElementById("booking-delay").innerText = xhr.response + " " + getNoun(xhr.response, "час", "часа", "часов")

        }
        xhr.open("GET", `/api/booking/get-delay`);
        xhr.send();
    }
    getBookingDelay()




    // Обновление счетчика корзины
    function updateCartCount(count) {
        cartCount = count;
        document.getElementById('cartCount').textContent = count;
        document.getElementById('floatingCartCount').textContent = count;
    }


    // Добавление товара в корзину
    function addToCart(product, quantity) {
        // Проверяем, есть ли уже товар в корзине
        const existingItemIndex = cartItems.findIndex(item => item.id === product.id);

        if (existingItemIndex !== -1) {
            // Обновляем количество

            if (cartItems[existingItemIndex].quantity < cartItems[existingItemIndex].max_quantity) {
                cartItems[existingItemIndex].quantity += quantity;
            }
        } else {
            // Добавляем новый товар
            cartItems.push({
                id: product.id,
                name: product.name,
                price: product.price,
                quantity: quantity,
                max_quantity: product.count,
            });
        }

        // Обновляем счетчик
        updateCartCount(cartItems.reduce((sum, item) => sum + item.quantity, 0));

        // Показываем уведомление
        //showNotification(`Добавлено в корзину: ${product.name} (${quantity} шт.)`);

        // Обновляем корзину
        renderCart();
    }


    function renderCart() {
        let cartItemsHtml = "";
        let cartTotal = 0;

        cartItems.forEach((product) => {
            let discount = 0;

            const promotion = promotions.find(p => p.product_code === product.id);
            if (promotion) {
                discount = promotion.discount;
            }

            let totalPrice = ((product.price/100) - discount) * product.quantity
            cartTotal += totalPrice

            cartItemsHtml += `
             <div class="list-group-item py-3">
                <div class="d-flex gap-3">
                    <div class="flex-shrink-0">
                        <img src="/image/${product.id}.webp" class="rounded"
                             style="width: 60px; height: 60px; object-fit: contain;" alt="">
                    </div>
                    <div class="flex-grow-1 d-flex flex-column">
                        <div class="mb-1">
                            <h6 class="mb-0 text-truncate-2" style="
                                display: -webkit-box;
                                -webkit-line-clamp: 2;
                                -webkit-box-orient: vertical;
                                overflow: hidden;
                                line-height: 1.3;
                            ">${product.name}</h6>
                            <div class="d-flex align-items-center justify-content-between mt-1">
                                <span class="text-muted small">${(product.price/100) - discount} ₽ × ${product.quantity}</span>
                                <span class="fw-bold">${totalPrice} ₽</span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="quantity-control">
                                <button class="btn btn-sm btn-outline-secondary decrease-qty p-1" style="width: 28px; height: 28px;" data-id="${product.id}">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input id="item-qty-input-${product.id}" type="number" min="1" value="${product.quantity}"
                                       class="form-control form-control-sm item-qty text-center"
                                       style="width: 40px; height: 28px;">
                                <button class="btn btn-sm btn-outline-secondary increase-qty p-1" style="width: 28px; height: 28px;" data-id="${product.id}">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <button class="btn btn-sm btn-outline-danger remove-item" data-id="${product.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            `
        });

        const cartTotalEl = document.getElementById("cartTotal");
        cartTotalEl.innerText = `${cartTotal} ₽`

        const cartItemsEL = document.getElementById("cartItems");
        cartItemsEL.innerHTML = cartItemsHtml;

        if (cartItems.length === 0) {
            document.getElementById("checkoutBtn").setAttribute("disabled", "");
            document.getElementById("booking-btn").setAttribute("disabled", "");
        } else if (storeInfo.booking_enable) {
            document.getElementById("checkoutBtn").removeAttribute("disabled");
            document.getElementById("booking-btn").removeAttribute("disabled");
        }


        // add event listeners

        document.querySelectorAll(".remove-item").forEach(btn => {
            btn.addEventListener('click', e => {
                const productId = btn.dataset.id;
                cartItems = cartItems.filter(prod => {
                    if (prod.id == productId) {
                        updateCartCount(cartCount-prod.quantity);
                        return false
                    }
                    return true
                })

                renderCart();
            })
        })

        document.querySelectorAll(".decrease-qty").forEach(btn => {
            btn.addEventListener('click', e => {
                const productId = btn.dataset.id;

                for (let i=0; i < cartItems.length; i++) {
                    if (cartItems[i].quantity > 1 && cartItems[i].id == productId) {
                        cartItems[i].quantity--
                        updateCartCount(cartCount-1);
                        renderCart();
                        break;
                    }
                }
            })
        })

        document.querySelectorAll(".increase-qty").forEach(btn => {
            btn.addEventListener('click', e => {
                const productId = btn.dataset.id;

                for (let i=0; i < cartItems.length; i++) {
                    if (cartItems[i].quantity < cartItems[i].max_quantity && cartItems[i].id == productId) {
                        cartItems[i].quantity++
                        updateCartCount(cartCount+1);
                        renderCart();
                        break;
                    }
                }
            })
        })

        saveCart();
    }

    function saveCart() {
        let exp = new Date();
        exp.setMonth(exp.getMonth()+1);
        setCookie("cart", JSON.stringify(cartItems), {path: "/", expires: exp});
    }

    function readCart() {
        let cartCookie = getCookie("cart");

        if (cartCookie) {
            let cart = JSON.parse(cartCookie)
            if (cart) {
                cartItems = cart;
                updateCartCount(cartItems.reduce((sum, item) => sum + item.quantity, 0));
            }
        }

        checkCartInStock()

        renderCart();
    }

    // Показать уведомление
    function showNotification(message) {
        // Создаем элемент уведомления
        const notification = document.createElement('div');
        notification.className = 'position-fixed bottom-0 end-0 p-3';
        notification.style.zIndex = '1100';

        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.role = 'alert';
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        toast.innerHTML = `
                <div class="toast-header bg-success text-white">
                    <strong class="me-auto"><i class="fas fa-check-circle me-2"></i>Успешно</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${message}</div>
            `;

        notification.appendChild(toast);
        document.body.appendChild(notification);

        // Автоматическое скрытие через 2 секунды
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 500);
        }, 2000);
    }

    function addAltImage(selector) {
        document.querySelectorAll(selector).forEach(el => {
            el.addEventListener("error", function () {
                el.setAttribute("src", "/static/img/no_product.webp")
                el.removeEventListener("error")
            })
        })
    }


    // Настройки пагинации
    const paginationConfig = {
        itemsPerPage: 20,  // Количество товаров на странице
        visiblePages: 5   // Количество видимых номеров страниц
    };

    // Функция для отображения результатов поиска с пагинацией
    function displaySearchResults(products, page = 1) {
        const resultsContainer = document.getElementById('searchResultsContainer');
        const resultsCount = document.getElementById('searchResultsCount');
        const searchResults = document.getElementById('searchResults');
        const pagination = document.getElementById('pagination');

        // Очищаем предыдущие результаты
        resultsContainer.innerHTML = '';
        pagination.innerHTML = '';

        if (products.length === 0) {
            resultsContainer.innerHTML = `
      <div class="col-12 text-center py-4">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h5>Ничего не найдено</h5>
        <p>Попробуйте изменить параметры поиска</p>
      </div>
    `;
            searchResults.classList.remove('d-none');
            return;
        }

        // Рассчитываем пагинацию
        const totalPages = Math.ceil(products.length / paginationConfig.itemsPerPage);
        const startIndex = (page - 1) * paginationConfig.itemsPerPage;
        const endIndex = Math.min(startIndex + paginationConfig.itemsPerPage, products.length);
        const paginatedProducts = products.slice(startIndex, endIndex);

        // Отображаем товары для текущей страницы
        paginatedProducts.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'col';

            const promotion = promotions.find(p => p.product_code === product.id);

            productCard.innerHTML = `
      <div class="card product-card h-100 ${product.count <= 0 ? 'out-of-stock' : ''}"
           data-product-id="${product.id}" onclick="showProductDetails(${product.id})">
        ${promotion ? '<div class="promotion-badge badge bg-danger">Акция</div>' : ''}
        <img src="/image/${product.id}.webp"
             class="card-img-top product-img" alt="${product.name}">
        <div class="card-body">
          <h5 class="card-title">${product.name}</h5>
          <p class="card-text text-muted small">${product.producer || 'Производитель не указан'}</p>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              ${promotion ? `<span class="old-price">${product.price/100} ₽</span>
              <div class="fw-bold text-primary">${(product.price/100) - promotion.discount} ₽</div>` :
                `<div class="fw-bold">${product.price/100} ₽</div>`}
            </div>
            ${product.count <= 0 ?
                '<span class="badge bg-danger">Нет в наличии</span>' :
                `<button class="btn btn-sm btn-outline-primary add-to-cart-btn" data-id="${product.id}">
                  В корзину</button>`
            }
          </div>
        </div>
      </div>
    `;

            resultsContainer.appendChild(productCard);
        });

        addAltImage("img.product-img");

        // Генерируем пагинацию
        if (totalPages > 1) {
            // Кнопка "Назад"
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous" data-page="${page - 1}">
      <span aria-hidden="true">&laquo;</span>
    </a>`;
            pagination.appendChild(prevLi);

            // Номера страниц
            const startPage = Math.max(1, page - Math.floor(paginationConfig.visiblePages / 2));
            const endPage = Math.min(totalPages, startPage + paginationConfig.visiblePages - 1);

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === page ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                pagination.appendChild(pageLi);
            }

            // Кнопка "Вперед"
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${page === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next" data-page="${page + 1}">
      <span aria-hidden="true">&raquo;</span>
    </a>`;
            pagination.appendChild(nextLi);
        }

        resultsCount.textContent = `Найдено: ${products.length}`;
        searchResults.classList.remove('d-none');

        // Прокручиваем к началу результатов
        searchResults.scrollIntoView({ behavior: 'smooth' });


        // Добавляем обработчики событий
        document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener('click', (e) => {
                if (!e.target.classList.contains('add-to-cart-btn')) {
                    const productId = card.dataset.id;
                    const product = products.find(p => p.id == productId);
                    if (product) showProductDetails(product);
                }
            });
        });

        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const productId = btn.dataset.id;
                const product = products.find(p => p.id == productId);
                if (product) addToCart(product, 1);
            });
        });
    }

    // Обработчик кликов по пагинации
    document.getElementById('pagination').addEventListener('click', function(e) {
        e.preventDefault();

        if (e.target.tagName === 'A') {
            const page = parseInt(e.target.dataset.page);
            if (!isNaN(page)) {
                // Сохраняем текущие результаты поиска
                const searchTerm = document.getElementById('searchInput').value.trim()

                displaySearchResults(products, page);
            }
        }
    });


    // Функция для показа детальной информации о товаре
    function showProductDetails(productId) {
        let product = products.find(p => p.id === productId);
        if (!product) {
            product = promoProducts[productId];
        }

        const promotion = promotions.find(p => p.product_code === productId);
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        console.log(product)
        if (!product) return;

        // Заполняем модальное окно данными
        document.getElementById('productModalTitle').textContent = product.name;
        document.getElementById('productModalDescription').textContent = product.description || 'Описание отсутствует';
        document.getElementById('productModalImage').src = `/image/${product.id}.webp`
        document.getElementById('productModalProducer').textContent = product.producer || 'Не указано';
        document.getElementById('productModalCountry').textContent = product.country || 'Не указано';
        document.getElementById('productModalGTIN').textContent = product.gtin || 'Не указано';
        document.getElementById('productModalQuantity').textContent = product.count;
        if (promotion) {
            document.getElementById('productModalPrice').textContent = `${(product.price/100) - promotion.discount} ₽`;
            document.getElementById('productModalOldPrice').innerHTML = `<del>${product.price/100} ₽</del>`;
        } else {
            document.getElementById('productModalPrice').textContent = `${product.price} ₽`;
            document.getElementById('productModalOldPrice').textContent = '';
        }

        const stockBadge = document.getElementById('productModalStock');
        if (product.count <= 0) {
            stockBadge.textContent = 'Нет в наличии';
            stockBadge.className = 'badge bg-danger';
            document.getElementById('addToCartFromModal').disabled = true;
        } else {
            stockBadge.textContent = 'В наличии';
            stockBadge.className = 'badge bg-success';
            document.getElementById('addToCartFromModal').disabled = false;
        }

        document.getElementById("addToCartFromModal").addEventListener("click", (btn) => {
            addToCart(product, 1)
        })

        // Показываем модальное окно
        modal.show();
    }


    function checkCartInStock(callback) {
        if (!callback) {
            callback = () => {}
        }

        let checkingProducts = []

        cartItems.forEach(prod => {
            checkingProducts.push({
                "id": prod.id,
                "count": prod.quantity
            })
        })

        xhr = new XMLHttpRequest();

        xhr.responseType = "json";
        xhr.onload = () => {
            if (!CheckCode(xhr)) {
                return
            }

            let result = xhr.response? xhr.response : [];

            if (result === checkingProducts) {
                callback();
                return;
            }

            let mapResult = {}
            result.forEach(el => mapResult[el.id] = el.count);


            let cartInStock = true;

            let resultCart = [];
            cartItems.forEach(item => {
                let resultCount = mapResult[item.id];
                if (resultCount) {
                    if (resultCount < item.quantity) {
                        item.quantity = resultCount
                        cartInStock = false;
                    }
                    if (resultCount > item.max_quantity) {
                        item.max_quantity = resultCount
                    }
                    resultCart.push(item);
                    return
                }
                cartInStock = false;
            })
            cartItems = resultCart;

            renderCart();

            if (cartInStock) {
                callback();
            } else {
                alert("Некоторых товаров в корзине нет в наличии");
            }
        }

        xhr.open("POST", `/api/products/check-in-stock?store_id=${storeId}`);
        xhr.send(JSON.stringify(checkingProducts));
    }



    document.addEventListener('DOMContentLoaded', function () {
        const promotionsContainer = document.getElementById("promotionsContainer");
        const searchBtn = document.getElementById('searchBtn');
        const searchInput = document.getElementById('searchInput');
        const clearCartBtn = document.getElementById('clearCartBtn');


        // Очистка корзины
        clearCartBtn.addEventListener("click", function () {
            cartItems = [];
            cartCount = 0;
            renderCart();
            updateCartCount(0);
        })

        // Обработчик поиска
        searchBtn.addEventListener('click', function() {
            const searchTerm = searchInput.value.trim();

            let xhr = new XMLHttpRequest();

            xhr.responseType = "json"
            xhr.onload = () => {
                if (!CheckCode(xhr)) {
                    return
                }

                products = xhr.response? xhr.response : []

                displaySearchResults(products);

            }
            xhr.open("GET", `/api/products/search?store_id=${storeId}&q=${searchTerm}`);
            xhr.send();
        });

        // Можно добавить поиск при нажатии Enter
        searchInput.addEventListener('keypress', function(e) {
            if (e.code === 'Enter') searchBtn.click();
        });

        // Оформление заказа
        document.getElementById('checkoutBtn').addEventListener('click', function() {
            checkCartInStock(() => {
                const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
                checkoutModal.show();
            })
        });

        // Обработка оформления заказа
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);

            let request = {
                "username": formData.get("username"),
                "phone": formData.get("phone"),
                "message": formData.get("message"),
                "products": []
            }
            let checkingProducts = []

            cartItems.forEach(prod => {
                request.products.push({
                    "code_stu": prod.id,
                    "name": prod.name,
                    "quantity": prod.quantity
                })
                checkingProducts.push({
                    "id": prod.id,
                    "count": prod.quantity
                })
            })

            // Закрываем окно оформления
            const checkoutModal = bootstrap.Modal.getInstance(document.getElementById('checkoutModal'));
            checkoutModal.hide();

            let xhr = new XMLHttpRequest();

            loadingIndicator();

            xhr.responseType = "json"
            xhr.onload = () => {
                loadingIndicator();
                if (!CheckCode(xhr)) {
                    return
                }

                let booking_id = xhr.response["book_id"];

                addBooking(booking_id)

                clearCartBtn.click();
                location.replace("/bookings");
            }

            xhr.open("POST", `/api/booking/create?store_id=${storeId}`);
            xhr.send(JSON.stringify(request));
        });



        function LoadPromotion() {
            let xhr = new XMLHttpRequest();

            xhr.responseType = "json"
            xhr.onload = () => {
                if (!CheckCode(xhr)) {
                    return
                }

                promotions = xhr.response;
                readCart();

                let promotionsHtml = ''

                for (let promo of promotions) {
                    if (promo.in_stock) {
                        promotionsHtml += `
                    <div class="col">
                    <div class="card product-card" onclick="showProductDetails(${promo.product_code})">
                        <div class="promotion-badge badge bg-danger">Акция</div>
                        <img src="/image/${promo.product_code}.webp" class="card-img-top product-img">
                        <div class="card-body">
                            <h5 class="card-title">${promo.product_name}</h5>
                            <p class="card-text text-muted small">${promo.product.producer}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="old-price">${promo.product.price / 100} ₽</span>
                                    <div class="fw-bold text-primary">${(promo.product.price - promo.discount * 100) / 100} ₽</div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary add-promo-to-cart-btn" data-id="${promo.product_code}">В корзину</button>
                            </div>
                        </div>
                    </div>
                </div>`

                        promoProducts[promo.product_code] = promo.product;
                    } else {
                        promotionsHtml += `
                    <div class="col">
                    <div class="card product-card out-of-stock" onclick="showProductDetails()">
                        <div class="promotion-badge badge bg-danger">Акция</div>
                        <img src="/image/${promo.product_code}.webp" class="card-img-top product-img">
                        <div class="card-body">
                            <h5 class="card-title">${promo.product_name}</h5>
                            <p class="card-text text-muted small"></p>
                            <div class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" disabled>
                                  Нет в наличии
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`
                    }
                }

                promotionsContainer.innerHTML = promotionsHtml

                addAltImage("img.product-img")

                document.querySelectorAll('.add-promo-to-cart-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const productId = btn.dataset.id;
                        addToCart(promoProducts[productId], 1);
                    });
                });
            }

            xhr.open("GET", `/api/promotion/get?store_id=${storeId}`)
            xhr.send()
        }

        getStoreInfo();
        LoadPromotion();
    })


</script>
</body>
</html>